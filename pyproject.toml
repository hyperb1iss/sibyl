# Sibyl - Collective Intelligence Runtime
# Root workspace configuration for dependency version management

# =============================================================================
# UV Workspace Configuration (virtual workspace - not a package)
# =============================================================================

[tool.uv]

# =============================================================================
# Version Constraints (enforced across all workspace members)
# Members use loose specs, these ensure consistent bounds
# =============================================================================
constraint-dependencies = [
    # Dev tooling
    "ruff>=0.14,<1.0",
    "ty>=0.0.10,<1.0",
    "pytest>=9.0,<10.0",
    "pytest-asyncio>=1.3,<2.0",
    "pytest-cov>=7.0,<8.0",
    "pre-commit>=4.0,<5.0",
    # E2E testing
    "httpx>=0.28,<1.0",
    "playwright>=1.50,<2.0",
    # Transitive deps (avoid yanked versions)
    "numpy>=2.4.1",
]

[tool.uv.workspace]
members = [
    "apps/api",
    "apps/cli",
    "apps/runner",
    "packages/python/sibyl-core",
]

# =============================================================================
# Shared Dependency Sources
# These are inherited by all workspace members
# =============================================================================

[tool.uv.sources]
# Local packages - workspace members reference each other
sibyl-core = { workspace = true }
sibyl-dev = { workspace = true }
sibyl-runner = { workspace = true }
sibyld = { workspace = true }

# =============================================================================
# Shared Tool Configuration
# =============================================================================

[tool.ruff]
line-length = 100
src = ["apps/*/src", "packages/*/src", "hooks"]

[tool.ruff.lint]
select = [
    "E", "F", "I", "UP", "B", "SIM", "RUF",
    "ASYNC", "S", "C4", "T20", "PT", "PL", "TRY",
]
ignore = [
    "E501",    # Line length (formatter handles)
    "S101",    # Assert (tests/contracts)
    "TRY003",  # Long exception messages
    "PLR0913", # Too many arguments
]

[tool.ruff.lint.per-file-ignores]
# Hooks need print for output, subprocess for CLI calls, silent failures
"hooks/*.py" = [
    "T20",     # print statements (needed for hook output)
    "S603",    # subprocess call (calling our own CLI)
    "S607",    # partial executable path (sibyl is in PATH)
    "S110",    # try-except-pass (intentional silent failures)
    "SIM105",  # contextlib.suppress (explicit try-except is clearer here)
    "PLR2004", # magic numbers (thresholds are clear in context)
]

[tool.ruff.lint.isort]
known-first-party = ["sibyl", "sibyl_core", "sibyl_cli"]

[tool.ty.environment]
python-version = "3.13"

[tool.ty.rules]
# External packages without stubs (FalkorDB, Graphiti, etc.)
unresolved-import = "ignore"
# Graphiti uses dynamic attributes
unresolved-attribute = "warn"
possibly-missing-attribute = "warn"
# Gradual adoption - start with warnings
invalid-argument-type = "warn"
invalid-return-type = "warn"
# Sentinel patterns and dynamic dict access - warn for now
invalid-assignment = "warn"
unsupported-operator = "warn"
# Runtime length checks not visible to static analysis
index-out-of-bounds = "warn"

[tool.ty.src]
include = ["apps/*/src/**/*.py", "packages/python/*/src/**/*.py", "hooks/*.py"]
exclude = ["**/build/**", "**/.venv/**", "**/migrations/**"]

# Hooks use sys.exit() for control flow which ty doesn't understand
[[tool.ty.overrides]]
include = ["hooks/*.py"]
[tool.ty.overrides.rules]
invalid-argument-type = "ignore"

# Intentional monkey-patching for FalkorDB concurrency fixes
[[tool.ty.overrides]]
include = ["**/graph/client.py"]
[tool.ty.overrides.rules]
invalid-assignment = "ignore"

# crawl4ai has complex union types that confuse ty
[[tool.ty.overrides]]
include = ["**/crawler/*.py"]
[tool.ty.overrides.rules]
missing-argument = "ignore"

# SQLAlchemy/SQLModel: column comparisons return ColumnElement, not bool
# Also affects .desc(), .asc(), .label(), .op() methods on mapped columns
# cli/*.py also has entity union types (EntitySummary | RelatedEntity | Unknown)
[[tool.ty.overrides]]
include = ["**/db/*.py", "**/api/routes/*.py", "**/auth/*.py", "**/cli/*.py"]
[tool.ty.overrides.rules]
invalid-argument-type = "ignore"
unresolved-attribute = "ignore"
no-matching-overload = "ignore"
unsupported-operator = "ignore"
possibly-missing-attribute = "ignore"

# arq worker/jobs: cron() function, SQLAlchemy queries
[[tool.ty.overrides]]
include = ["**/jobs/*.py"]
[tool.ty.overrides.rules]
invalid-argument-type = "ignore"

# TypedDict hook outputs, SQLAlchemy in agents, runner union types
[[tool.ty.overrides]]
include = ["**/agents/*.py"]
[tool.ty.overrides.rules]
invalid-argument-type = "ignore"
possibly-missing-attribute = "ignore"

# FastAPI/Starlette middleware and app setup
[[tool.ty.overrides]]
include = ["**/api/app.py", "**/server.py", "**/locks.py"]
[tool.ty.overrides.rules]
invalid-argument-type = "ignore"

# crawl4ai service types - result container union
[[tool.ty.overrides]]
include = ["**/crawler/service.py"]
[tool.ty.overrides.rules]
invalid-argument-type = "ignore"
possibly-missing-attribute = "ignore"

# Graph entity manager - dynamic dict access
[[tool.ty.overrides]]
include = ["**/graph/entities.py"]
[tool.ty.overrides.rules]
invalid-argument-type = "ignore"

[tool.pytest.ini_options]
asyncio_mode = "auto"
asyncio_default_fixture_loop_scope = "function"
addopts = ["-ra", "--strict-markers", "-v"]
filterwarnings = [
    "error",
    "ignore::DeprecationWarning",
    "ignore::pytest.PytestUnraisableExceptionWarning",
]

[dependency-groups]
dev = [
    "ty>=0.0.13",
]
