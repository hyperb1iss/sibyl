# https://moonrepo.dev/docs/config/project
$schema: https://moonrepo.dev/schemas/project.json

language: typescript
layer: application
toolchains:
  default: node

fileGroups:
  sources:
    - src/**/*
  tests:
    - src/**/*.test.{ts,tsx}
    - src/**/*.spec.{ts,tsx}
  configs:
    - package.json
    - tsconfig.json
    - next.config.ts
    - biome.json

tasks:
  # Linting & Formatting
  lint:
    command: pnpm biome check .
    inputs:
      - "@group(sources)"
      - "@group(configs)"

  fix:
    command: pnpm biome check --write .
    inputs:
      - "@group(sources)"
    preset: server

  fix-all:
    command: pnpm biome check --write --unsafe .
    inputs:
      - "@group(sources)"
    preset: server

  format:
    command: pnpm biome format --write .
    inputs:
      - "@group(sources)"
    preset: server

  # Type Checking
  typecheck:
    command: pnpm tsc --noEmit
    inputs:
      - "@group(sources)"
      - "@group(configs)"

  # Testing
  test:
    command: pnpm vitest run
    inputs:
      - "@group(sources)"
      - "@group(tests)"

  test-watch:
    command: pnpm vitest
    preset: server
    options:
      persistent: true

  test-cov:
    command: pnpm vitest run --coverage
    inputs:
      - "@group(sources)"
      - "@group(tests)"

  # Development
  dev:
    command: pnpm next dev --port 3337
    preset: server
    options:
      persistent: true

  # Build
  build:
    command: pnpm next build
    inputs:
      - "@group(sources)"
      - "@group(configs)"
    # Note: .next excluded from outputs - Next.js manages its own cache,
    # and the directory contains symlinks that break moon's archiver

  start:
    command: pnpm next start --port 3337
    preset: server
    deps:
      - ~:build
    options:
      persistent: true

  # Code Generation
  generate-types:
    command: pnpm openapi-typescript http://localhost:3334/api/openapi.json -o src/lib/api-types.ts
    preset: server
    outputs:
      - src/lib/api-types.ts

  # Storybook
  storybook:
    command: pnpm storybook dev -p 6006
    preset: server
    options:
      persistent: true

  build-storybook:
    command: pnpm build-storybook
    inputs:
      - "@group(sources)"
    outputs:
      - storybook-static
